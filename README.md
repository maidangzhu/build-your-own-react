# Build Your Own React 18

ä»å¤´å®ç°ä¸€ä¸ªç®€æ˜“çš„ React 18ï¼Œæ·±å…¥ç†è§£ React çš„æ ¸å¿ƒåŸç†å’Œ Fiber æ¶æ„ã€‚

## ğŸ¯ é¡¹ç›®ç›®æ ‡

- ç†è§£ React 18 çš„ Fiber æ¶æ„
- æŒæ¡ JSX è½¬æ¢å’Œè™šæ‹Ÿ DOM æ¦‚å¿µ
- å®ç°åŸºç¡€çš„ Hooks ç³»ç»Ÿ (useState, useEffect, useReducer)
- äº†è§£ React çš„è°ƒåº¦å™¨å’Œæ—¶é—´åˆ‡ç‰‡
- å®ç°ç®€å•çš„äº‹ä»¶ç³»ç»Ÿå’Œ DOM æ“ä½œ

## ğŸ“ é¡¹ç›®ç»“æ„

```
src/
â”œâ”€â”€ react/                 # React æ ¸å¿ƒå®ç°
â”‚   â”œâ”€â”€ jsx/               # JSX å¤„ç†
â”‚   â”‚   â”œâ”€â”€ createElement.ts
â”‚   â”‚   â””â”€â”€ Fragment.ts
â”‚   â”œâ”€â”€ hooks/             # Hooks ç³»ç»Ÿ
â”‚   â”‚   â”œâ”€â”€ index.ts
â”‚   â”‚   â”œâ”€â”€ useState.ts
â”‚   â”‚   â”œâ”€â”€ useEffect.ts
â”‚   â”‚   â””â”€â”€ useReducer.ts
â”‚   â”œâ”€â”€ reconciler/        # åè°ƒå™¨
â”‚   â”‚   â”œâ”€â”€ index.ts
â”‚   â”‚   â”œâ”€â”€ fiber.ts
â”‚   â”‚   â””â”€â”€ diff.ts
â”‚   â”œâ”€â”€ scheduler/         # è°ƒåº¦å™¨
â”‚   â”‚   â”œâ”€â”€ index.ts
â”‚   â”‚   â”œâ”€â”€ workLoop.ts
â”‚   â”‚   â””â”€â”€ priority.ts
â”‚   â””â”€â”€ index.ts
â”œâ”€â”€ react-dom/             # ReactDOM å®ç°
â”‚   â”œâ”€â”€ client/            # å®¢æˆ·ç«¯æ¸²æŸ“
â”‚   â”‚   â”œâ”€â”€ createRoot.ts
â”‚   â”‚   â””â”€â”€ render.ts
â”‚   â”œâ”€â”€ events/            # äº‹ä»¶ç³»ç»Ÿ
â”‚   â”‚   â”œâ”€â”€ index.ts
â”‚   â”‚   â”œâ”€â”€ SyntheticEvent.ts
â”‚   â”‚   â””â”€â”€ EventListener.ts
â”‚   â””â”€â”€ index.ts
â”œâ”€â”€ shared/                # å…±äº«å·¥å…·å’Œç±»å‹
â”‚   â”œâ”€â”€ types.ts
â”‚   â””â”€â”€ utils.ts
â””â”€â”€ examples/              # ç¤ºä¾‹å’Œæµ‹è¯•
    â”œâ”€â”€ App.tsx
    â”œâ”€â”€ Counter.tsx
    â”œâ”€â”€ TodoList.tsx
    â””â”€â”€ EffectExample.tsx
```

## ğŸ—ï¸ æ ¸å¿ƒæ¶æ„

### 1. JSX å¤„ç†å±‚

- **createElement**: å°† JSX è½¬æ¢ä¸º React Element
- **Fragment**: æ”¯æŒå¤šä¸ªå­å…ƒç´ çš„å®¹å™¨

### 2. Fiber æ¶æ„

- **Fiber èŠ‚ç‚¹**: React 18 çš„æ ¸å¿ƒæ•°æ®ç»“æ„
- **åŒç¼“å­˜**: current æ ‘å’Œ workInProgress æ ‘
- **é“¾è¡¨ç»“æ„**: childã€siblingã€parent æŒ‡é’ˆ

### 3. è°ƒåº¦å™¨ (Scheduler)

- **æ—¶é—´åˆ‡ç‰‡**: å°†æ¸²æŸ“å·¥ä½œåˆ†è§£ä¸ºå°ä»»åŠ¡
- **ä¼˜å…ˆçº§**: ä¸åŒæ›´æ–°çš„ä¼˜å…ˆçº§ç®¡ç†
- **å¯ä¸­æ–­æ¸²æŸ“**: æ”¯æŒé«˜ä¼˜å…ˆçº§ä»»åŠ¡æ’é˜Ÿ

### 4. åè°ƒå™¨ (Reconciler)

- **Diff ç®—æ³•**: æ¯”è¾ƒæ–°æ—§è™šæ‹Ÿ DOM æ ‘
- **Effect æ ‡è®°**: æ ‡è®°éœ€è¦çš„ DOM æ“ä½œ
- **æäº¤é˜¶æ®µ**: å°†å˜æ›´åº”ç”¨åˆ°çœŸå® DOM

### 5. Hooks ç³»ç»Ÿ

- **useState**: çŠ¶æ€ç®¡ç†
- **useEffect**: å‰¯ä½œç”¨å¤„ç†
- **useReducer**: å¤æ‚çŠ¶æ€ç®¡ç†

### 6. äº‹ä»¶ç³»ç»Ÿ

- **äº‹ä»¶ä»£ç†**: åœ¨æ ¹èŠ‚ç‚¹ç»Ÿä¸€å¤„ç†äº‹ä»¶
- **åˆæˆäº‹ä»¶**: è·¨æµè§ˆå™¨å…¼å®¹çš„äº‹ä»¶å¯¹è±¡

## ğŸš€ å®ç°æ­¥éª¤

### é˜¶æ®µ 1: JSX å’ŒåŸºç¡€æ¸²æŸ“

1. å®ç° `createElement` å‡½æ•°
2. å®ç° `Fragment` ç»„ä»¶
3. åˆ›å»ºåŸºç¡€çš„ DOM æ“ä½œå·¥å…·
4. å®ç°ç®€å•çš„ `render` å‡½æ•°

### é˜¶æ®µ 2: Fiber æ¶æ„

1. å®šä¹‰ Fiber èŠ‚ç‚¹ç»“æ„
2. å®ç° Fiber æ ‘çš„æ„å»º
3. å®ç°åŒç¼“å­˜æœºåˆ¶
4. åŸºç¡€çš„ Reconciler é€»è¾‘

### é˜¶æ®µ 3: è°ƒåº¦å™¨

1. å®ç°å·¥ä½œå¾ªç¯ (workLoop)
2. æ·»åŠ æ—¶é—´åˆ‡ç‰‡æ”¯æŒ
3. å®ç°ä»»åŠ¡ä¼˜å…ˆçº§
4. å¯ä¸­æ–­æ¸²æŸ“æœºåˆ¶

### é˜¶æ®µ 4: Hooks ç³»ç»Ÿ

1. å®ç° Hooks çš„åŸºç¡€æ¶æ„
2. å®ç° `useState` Hook
3. å®ç° `useEffect` Hook
4. å®ç° `useReducer` Hook

### é˜¶æ®µ 5: äº‹ä»¶ç³»ç»Ÿ

1. å®ç°äº‹ä»¶ä»£ç†æœºåˆ¶
2. åˆ›å»ºåˆæˆäº‹ä»¶å¯¹è±¡
3. äº‹ä»¶çš„ç»‘å®šå’Œè§£ç»‘
4. äº‹ä»¶ä¼˜å…ˆçº§å¤„ç†

### é˜¶æ®µ 6: ä¼˜åŒ–å’Œæµ‹è¯•

1. å®ç°å®Œæ•´çš„ Diff ç®—æ³•
2. æ€§èƒ½ä¼˜åŒ–
3. åˆ›å»ºæµ‹è¯•ç¤ºä¾‹
4. é”™è¯¯å¤„ç†å’Œè¾¹ç•Œæƒ…å†µ

## ğŸ”§ å¼€å‘ç¯å¢ƒ

```bash
# å®‰è£…ä¾èµ–
pnpm install

# å¯åŠ¨å¼€å‘æœåŠ¡å™¨
pnpm dev

# æ„å»ºé¡¹ç›®
pnpm build
```

## ğŸ“š æ ¸å¿ƒæ¦‚å¿µè¯¦è§£

### Fiber æ¶æ„

Fiber æ˜¯ React 16 å¼•å…¥çš„æ–°æ¶æ„ï¼Œå®ƒå°†æ¸²æŸ“å·¥ä½œåˆ†è§£ä¸ºå°çš„å·¥ä½œå•å…ƒï¼Œä½¿å¾— React å¯ä»¥ï¼š

- æš‚åœå·¥ä½œå¹¶ç¨åæ¢å¤
- ä¸ºä¸åŒç±»å‹çš„å·¥ä½œåˆ†é…ä¼˜å…ˆçº§
- é‡ç”¨ä¹‹å‰å®Œæˆçš„å·¥ä½œ
- å¦‚æœä¸å†éœ€è¦åˆ™ä¸­æ­¢å·¥ä½œ

### åŒç¼“å­˜

React ä½¿ç”¨åŒç¼“å­˜æŠ€æœ¯ï¼š

- **current æ ‘**: å½“å‰æ˜¾ç¤ºåœ¨å±å¹•ä¸Šçš„ Fiber æ ‘
- **workInProgress æ ‘**: æ­£åœ¨å†…å­˜ä¸­æ„å»ºçš„ Fiber æ ‘
- å®Œæˆåä¸¤æ£µæ ‘ä¼šäº¤æ¢ï¼Œå®ç°å¿«é€Ÿåˆ‡æ¢

### æ—¶é—´åˆ‡ç‰‡

é€šè¿‡ `requestIdleCallback` æˆ– `MessageChannel` å®ç°ï¼š

- æ¯ä¸ªæ—¶é—´ç‰‡æœ€å¤šå·¥ä½œ 5ms
- å¦‚æœæœ‰æ›´é«˜ä¼˜å…ˆçº§ä»»åŠ¡ï¼Œä¼šä¸­æ–­å½“å‰å·¥ä½œ
- æµè§ˆå™¨ç©ºé—²æ—¶ç»§ç»­ä¹‹å‰çš„å·¥ä½œ

### Hooks åŸç†

Hooks é€šè¿‡é“¾è¡¨å­˜å‚¨åœ¨ Fiber èŠ‚ç‚¹ä¸Šï¼š

- æ¯ä¸ª Hook éƒ½æœ‰è‡ªå·±çš„çŠ¶æ€
- é€šè¿‡ `hookIndex` ç¡®ä¿ Hooks è°ƒç”¨é¡ºåº
- ä¾èµ–æ•°ç»„ç”¨äºä¼˜åŒ–æ€§èƒ½

## ğŸ¨ ç¤ºä¾‹ä»£ç ç»“æ„

é¡¹ç›®å®Œæˆåï¼Œä½ å¯ä»¥è¿™æ ·ä½¿ç”¨ï¼š

```tsx
import React from "./react";
import ReactDOM from "./react-dom";

function Counter() {
  const [count, setCount] = React.useState(0);

  React.useEffect(() => {
    console.log("Count changed:", count);
  }, [count]);

  return (
    <div>
      <p>Count: {count}</p>
      <button onClick={() => setCount(count + 1)}>Increment</button>
    </div>
  );
}

const root = ReactDOM.createRoot(document.getElementById("root"));
root.render(<Counter />);
```

## ğŸ” è°ƒè¯•æŠ€å·§

1. **Fiber æ ‘å¯è§†åŒ–**: åœ¨æ§åˆ¶å°æ‰“å° Fiber æ ‘ç»“æ„
2. **å·¥ä½œå¾ªç¯è·Ÿè¸ª**: è®°å½•æ¯ä¸ªå·¥ä½œå•å…ƒçš„å¤„ç†è¿‡ç¨‹
3. **Hooks çŠ¶æ€ç›‘æ§**: è·Ÿè¸ª Hooks çš„çŠ¶æ€å˜åŒ–
4. **è°ƒåº¦å™¨æ—¥å¿—**: è®°å½•ä»»åŠ¡çš„è°ƒåº¦å’Œæ‰§è¡Œè¿‡ç¨‹

## ğŸ“– å­¦ä¹ èµ„æº

- [React Fiber æ¶æ„](https://github.com/acdlite/react-fiber-architecture)
- [React æºç è§£æ](https://react.jokcy.me/)
- [Build Your Own React](https://pomb.us/build-your-own-react/)

## ğŸ¯ å­¦ä¹ ç›®æ ‡

å®Œæˆè¿™ä¸ªé¡¹ç›®åï¼Œä½ å°†æ·±å…¥ç†è§£ï¼š

- React çš„æ ¸å¿ƒåŸç†å’Œè®¾è®¡æ€æƒ³
- Fiber æ¶æ„çš„ä¼˜åŠ¿å’Œå®ç°ç»†èŠ‚
- Hooks çš„å·¥ä½œæœºåˆ¶
- ç°ä»£å‰ç«¯æ¡†æ¶çš„è°ƒåº¦å’Œä¼˜åŒ–ç­–ç•¥
- è™šæ‹Ÿ DOM å’Œ Diff ç®—æ³•çš„å®ç°

å¼€å§‹ä½ çš„ React 18 å®ç°ä¹‹æ—…å§ï¼ğŸš€


```mermaid
graph TB
    subgraph "é˜¶æ®µ1: åŸºç¡€æ¶æ„"
        A1["createElement<br/>JSXè½¬æ¢"] --> A2["Fragment<br/>å¤šå­å…ƒç´ æ”¯æŒ"]
        A3["shared-utils<br/>å·¥å…·å‡½æ•°"] --> A4["DOMæ“ä½œ<br/>åŸºç¡€DOM API"]
        A1 --> A5["Fiberç»“æ„<br/>æ ¸å¿ƒæ•°æ®ç»“æ„"]
        A3 --> A5
    end
    
    subgraph "é˜¶æ®µ2: æ¸²æŸ“å¼•æ“"
        A5 --> B1["Reconciler<br/>åè°ƒå™¨"]
        A4 --> B1
        B1 --> B2["Scheduler<br/>è°ƒåº¦å™¨"]
        B2 --> B3["createRoot & render<br/>æ¸²æŸ“å…¥å£"]
    end
    
    subgraph "é˜¶æ®µ3: Hooksç³»ç»Ÿ"
        B3 --> C1["Hooksæ¶æ„<br/>åŸºç¡€æ¡†æ¶"]
        C1 --> C2["useState<br/>çŠ¶æ€ç®¡ç†"]
        C2 --> C3["useEffect<br/>å‰¯ä½œç”¨"]
        C2 --> C4["useReducer<br/>å¤æ‚çŠ¶æ€"]
    end
    
    subgraph "é˜¶æ®µ4: äº¤äº’èƒ½åŠ›"
        B3 --> D1["äº‹ä»¶ç³»ç»Ÿ<br/>ç”¨æˆ·äº¤äº’"]
        B1 --> D2["Diffç®—æ³•<br/>æ€§èƒ½ä¼˜åŒ–"]
    end
    
    subgraph "é˜¶æ®µ5: ç¤ºä¾‹éªŒè¯"
        C2 --> E1["Counterç¤ºä¾‹<br/>çŠ¶æ€æµ‹è¯•"]
        D1 --> E1
        C4 --> E2["TodoListç¤ºä¾‹<br/>åˆ—è¡¨æ¸²æŸ“"]
        D2 --> E2
        C3 --> E3["Effectsç¤ºä¾‹<br/>å‰¯ä½œç”¨æµ‹è¯•"]
    end
    
    subgraph "é˜¶æ®µ6: ä¼˜åŒ–å®Œå–„"
        B2 --> F1["æ‰¹é‡æ›´æ–°<br/>æ€§èƒ½ä¼˜åŒ–"]
        B2 --> F2["ä¼˜å…ˆçº§è°ƒåº¦<br/>å“åº”æ€§ä¼˜åŒ–"]
        C1 --> F3["é”™è¯¯å¤„ç†<br/>å¥å£®æ€§"]
    end
    
    style A1 fill:#e3f2fd
    style A5 fill:#e8f5e8
    style B2 fill:#fff3e0
    style C2 fill:#fce4ec
    style D1 fill:#f3e5f5
    style E1 fill:#e0f2f1
  ```